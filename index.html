<!--
I'm new, go easy...

Give Credit were it's due, The_Bugs
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Matthew's Github Portfolio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="style.css" rel="stylesheet" type="text/css" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
</head>

  <body>
    <!-- ===== Crossfading page background (bg.png <-> bg2.png) ===== -->
    <div class="page-bg page-bg--day" aria-hidden="true"></div>
    <div class="page-bg page-bg--night" aria-hidden="true"></div>
    <!-- ===== Star Parallax Background ===== -->
    <div id="stars" aria-hidden="true"></div>
    <div id="stars2" aria-hidden="true"></div>
    <div id="stars3" aria-hidden="true"></div>


    <!-- ===== Birds (behind video) ===== -->
    <div class="birds-layer" aria-hidden="true">
      <div class="bird-container bird-container-one">
        <div class="bird bird-one"></div>
      </div>
      <div class="bird-container bird-container-two">
        <div class="bird bird-two"></div>
      </div>
      <div class="bird-container bird-container-three">
        <div class="bird bird-three"></div>
      </div>
      <div class="bird-container bird-container-four">
        <div class="bird bird-four"></div>
      </div>
    </div>


    <!-- ===== Confetti ===== -->
    <div class="confetti-container" aria-hidden="true">
      <div class="confetti">●</div>
      <div class="confetti">◆</div>
      <div class="confetti">■</div>
      <div class="confetti">✦</div>
      <div class="confetti">★</div>
      <div class="confetti">●</div>
      <div class="confetti">◆</div>
      <div class="confetti">■</div>
      <div class="confetti">✦</div>
      <div class="confetti">★</div>
    </div>

    <!-- ===== Animated Title ===== -->
    <div class="site-title-video" aria-hidden="true">
      <img class="title-day" src="Title_Day_Gif.gif" alt="" />
      <img class="title-night" src="Title_Night_gif.gif" alt=""
           onerror="this.onerror=null; this.src='Title_Night_Gif.gif';" />
    </div>

    <div class="search">
      <form action="javascript:search()">
        <input
          id="search"
          value=""
          placeholder="Search..."
          type="input"
          spellcheck="false"
          autocomplete="off"
          autofocus
        />
      </form>
    </div>

    <!-- Buttons: click is reliable and counts as a user gesture -->
    <div class="buttons">
      <button type="button" onmouseover="fishy()">1</button>
      <button type="button" onmouseover="peng()">2</button>
      <button type="button" onmouseover="foot()">#</button>
    </div>

    <!-- Background video frame -->
    <div class="back-img" id="back-img">
      <video id="bgvid" class="bgvid" autoplay muted loop playsinline>
        <source src="TrainRide.webm" type="video/webm" />
      </video>

<!-- ===== Subway Menu Overlay (SVG only) ===== -->
<div class="subway-overlay" aria-label="Subway navigation">
  <svg viewBox="0 0 1200 520" aria-label="Interactive subway map">
          <!-- ROUTES -->
          <g class="route" data-route="general" style="--prog: 0; --len: 1;">
            <path id="path-general" class="line-base" d="M120 110 H640 Q700 110 700 170 V210 H940" />
            <path class="line-color general"       d="M120 110 H640 Q700 110 700 170 V210 H940" />
            <path class="line-active"              d="M120 110 H640 Q700 110 700 170 V210 H940" />
            <g class="tracker" style="color: var(--general);" transform="translate(120 110)">
              <circle class="tracker-pulse" r="10"></circle>
              <circle class="tracker-dot" r="8"></circle>
            </g>
          </g>

          <g class="route" data-route="art" style="--prog: 0; --len: 1;">
            <path id="path-art" class="line-base" d="M460 60 V210 H700" />
            <path class="line-color art"         d="M460 60 V210 H700" />
            <path class="line-active"            d="M460 60 V210 H700" />
            <g class="tracker" style="color: var(--art);" transform="translate(460 60)">
              <circle class="tracker-pulse" r="10"></circle>
              <circle class="tracker-dot" r="8"></circle>
            </g>
          </g>

          <g class="route" data-route="code" style="--prog: 0; --len: 1;">
            <path id="path-code" class="line-base" d="M140 360 H620 Q660 360 660 320 V260 H700" />
            <path class="line-color code"        d="M140 360 H620 Q660 360 660 320 V260 H700" />
            <path class="line-active"             d="M140 360 H620 Q660 360 660 320 V260 H700" />
            <g class="tracker" style="color: var(--code);" transform="translate(140 360)">
              <circle class="tracker-pulse" r="10"></circle>
              <circle class="tracker-dot" r="8"></circle>
            </g>
          </g>

          <!-- ✅ NEW PARALLEL LINE (horizontal, under Code line) -->
          <g class="route" data-route="parallel" style="--prog: 0; --len: 1;">
            <path id="path-parallel" class="line-base" d="M180 420 H740" />
            <path class="line-color parallel"    d="M180 420 H740" />
            <path class="line-active"            d="M180 420 H740" />
            <g class="tracker" style="color: var(--parallel);" transform="translate(180 420)">
              <circle class="tracker-pulse" r="10"></circle>
              <circle class="tracker-dot" r="8"></circle>
            </g>
          </g>

          <g class="route" data-route="misc" style="--prog: 0; --len: 1;">
            <path id="path-misc" class="line-base" d="M940 70 V420" />
            <path class="line-color misc"        d="M940 70 V420" />
            <path class="line-active"             d="M940 70 V420" />
            <g class="tracker" style="color: var(--misc);" transform="translate(940 70)">
              <circle class="tracker-pulse" r="10"></circle>
              <circle class="tracker-dot" r="8"></circle>
            </g>
          </g>

          <!-- STATIONS -->
          <!-- General -->
          <g class="station" data-id="general" data-title="General" data-parent="general" data-x="120" data-y="110" tabindex="0">
            <circle class="station-ring" cx="120" cy="110" r="14"></circle>
            <circle class="station-node" cx="120" cy="110" r="10"></circle>
            <circle class="station-hit" cx="120" cy="110" r="26"></circle>
            <text class="station-label" x="120" y="78" text-anchor="middle">General</text>
          </g>
          <g class="station" data-id="general-sub-1" data-title="General • Sub 1" data-parent="general" data-x="320" data-y="110" tabindex="0">
            <circle class="station-ring" cx="320" cy="110" r="14"></circle>
            <circle class="station-node" cx="320" cy="110" r="10"></circle>
            <circle class="station-hit" cx="320" cy="110" r="26"></circle>
            <text class="station-label" x="320" y="78" text-anchor="middle">General <tspan class="sub">• Sub 1</tspan></text>
          </g>
          <g class="station" data-id="general-sub-2" data-title="General • Sub 2" data-parent="general" data-x="520" data-y="110" tabindex="0">
            <circle class="station-ring" cx="520" cy="110" r="14"></circle>
            <circle class="station-node" cx="520" cy="110" r="10"></circle>
            <circle class="station-hit" cx="520" cy="110" r="26"></circle>
            <text class="station-label" x="520" y="78" text-anchor="middle">General <tspan class="sub">• Sub 2</tspan></text>
          </g>
          <g class="station" data-id="central" data-title="Central Interchange" data-parent="general" data-x="700" data-y="210" tabindex="0">
            <circle class="station-ring" cx="700" cy="210" r="18"></circle>
            <circle class="station-node interchange" cx="700" cy="210" r="12"></circle>
            <circle class="station-hit" cx="700" cy="210" r="30"></circle>
            <text class="station-label" x="740" y="214" text-anchor="start">Central <tspan class="sub">Interchange</tspan></text>
          </g>
          <g class="station" data-id="general-east" data-title="General • East" data-parent="general" data-x="860" data-y="210" tabindex="0">
            <circle class="station-ring" cx="860" cy="210" r="14"></circle>
            <circle class="station-node" cx="860" cy="210" r="10"></circle>
            <circle class="station-hit" cx="860" cy="210" r="26"></circle>
            <text class="station-label" x="860" y="178" text-anchor="middle">General <tspan class="sub">• East</tspan></text>
          </g>

          <!-- Art -->
          <g class="station" data-id="art" data-title="Art" data-parent="art" data-x="460" data-y="60" tabindex="0">
            <circle class="station-ring" cx="460" cy="60" r="14"></circle>
            <circle class="station-node" cx="460" cy="60" r="10"></circle>
            <circle class="station-hit" cx="460" cy="60" r="26"></circle>
            <text class="station-label" x="460" y="28" text-anchor="middle">Art</text>
          </g>
          <g class="station" data-id="art-sub-1" data-title="Art • Sub 1" data-parent="art" data-x="460" data-y="120" tabindex="0">
            <circle class="station-ring" cx="460" cy="120" r="14"></circle>
            <circle class="station-node" cx="460" cy="120" r="10"></circle>
            <circle class="station-hit" cx="460" cy="120" r="26"></circle>
            <text class="station-label" x="420" y="124" text-anchor="end">Art <tspan class="sub">• Sub 1</tspan></text>
          </g>
          <g class="station" data-id="art-sub-2" data-title="Art • Sub 2" data-parent="art" data-x="460" data-y="180" tabindex="0">
            <circle class="station-ring" cx="460" cy="180" r="14"></circle>
            <circle class="station-node" cx="460" cy="180" r="10"></circle>
            <circle class="station-hit" cx="460" cy="180" r="26"></circle>
            <text class="station-label" x="420" y="184" text-anchor="end">Art <tspan class="sub">• Sub 2</tspan></text>
          </g>
          <g class="station" data-id="art-sub-3" data-title="Art • Sub 3" data-parent="art" data-x="460" data-y="240" tabindex="0">
            <circle class="station-ring" cx="460" cy="240" r="14"></circle>
            <circle class="station-node" cx="460" cy="240" r="10"></circle>
            <circle class="station-hit" cx="460" cy="240" r="26"></circle>
            <text class="station-label" x="420" y="244" text-anchor="end">Art <tspan class="sub">• Sub 3</tspan></text>
          </g>

          <!-- Code -->
          <g class="station" data-id="code" data-title="Code" data-parent="code" data-x="140" data-y="360" tabindex="0">
            <circle class="station-ring" cx="140" cy="360" r="14"></circle>
            <circle class="station-node" cx="140" cy="360" r="10"></circle>
            <circle class="station-hit" cx="140" cy="360" r="26"></circle>
            <text class="station-label" x="140" y="328" text-anchor="middle">Code</text>
          </g>
          <g class="station" data-id="code-sub-1" data-title="Code • Sub 1" data-parent="code" data-x="280" data-y="360" tabindex="0">
            <circle class="station-ring" cx="280" cy="360" r="14"></circle>
            <circle class="station-node" cx="280" cy="360" r="10"></circle>
            <circle class="station-hit" cx="280" cy="360" r="26"></circle>
            <text class="station-label" x="280" y="328" text-anchor="middle">Code <tspan class="sub">• Sub 1</tspan></text>
          </g>
          <g class="station" data-id="code-sub-2" data-title="Code • Sub 2" data-parent="code" data-x="420" data-y="360" tabindex="0">
            <circle class="station-ring" cx="420" cy="360" r="14"></circle>
            <circle class="station-node" cx="420" cy="360" r="10"></circle>
            <circle class="station-hit" cx="420" cy="360" r="26"></circle>
            <text class="station-label" x="420" y="328" text-anchor="middle">Code <tspan class="sub">• Sub 2</tspan></text>
          </g>
          <g class="station" data-id="code-sub-3" data-title="Code • Sub 3" data-parent="code" data-x="560" data-y="360" tabindex="0">
            <circle class="station-ring" cx="560" cy="360" r="14"></circle>
            <circle class="station-node" cx="560" cy="360" r="10"></circle>
            <circle class="station-hit" cx="560" cy="360" r="26"></circle>
            <text class="station-label" x="560" y="328" text-anchor="middle">Code <tspan class="sub">• Sub 3</tspan></text>
          </g>
          <g class="station" data-id="code-sub-4" data-title="Code • Sub 4" data-parent="code" data-x="660" data-y="320" tabindex="0">
            <circle class="station-ring" cx="660" cy="320" r="14"></circle>
            <circle class="station-node" cx="660" cy="320" r="10"></circle>
            <circle class="station-hit" cx="660" cy="320" r="26"></circle>
            <text class="station-label" x="660" y="288" text-anchor="middle">Code <tspan class="sub">• Sub 4</tspan></text>
          </g>

          <!-- Parallel line stops -->
          <g class="station" data-id="parallel" data-title="Parallel" data-parent="parallel" data-x="180" data-y="420" tabindex="0">
            <circle class="station-ring" cx="180" cy="420" r="14"></circle>
            <circle class="station-node" cx="180" cy="420" r="10"></circle>
            <circle class="station-hit" cx="180" cy="420" r="26"></circle>
            <text class="station-label" x="180" y="388" text-anchor="middle">Parallel</text>
          </g>
          <g class="station" data-id="parallel-sub-1" data-title="Parallel • Sub 1" data-parent="parallel" data-x="340" data-y="420" tabindex="0">
            <circle class="station-ring" cx="340" cy="420" r="14"></circle>
            <circle class="station-node" cx="340" cy="420" r="10"></circle>
            <circle class="station-hit" cx="340" cy="420" r="26"></circle>
            <text class="station-label" x="340" y="388" text-anchor="middle">Parallel <tspan class="sub">• Sub 1</tspan></text>
          </g>
          <g class="station" data-id="parallel-sub-2" data-title="Parallel • Sub 2" data-parent="parallel" data-x="500" data-y="420" tabindex="0">
            <circle class="station-ring" cx="500" cy="420" r="14"></circle>
            <circle class="station-node" cx="500" cy="420" r="10"></circle>
            <circle class="station-hit" cx="500" cy="420" r="26"></circle>
            <text class="station-label" x="500" y="388" text-anchor="middle">Parallel <tspan class="sub">• Sub 2</tspan></text>
          </g>
          <g class="station" data-id="parallel-sub-3" data-title="Parallel • Sub 3" data-parent="parallel" data-x="660" data-y="420" tabindex="0">
            <circle class="station-ring" cx="660" cy="420" r="14"></circle>
            <circle class="station-node" cx="660" cy="420" r="10"></circle>
            <circle class="station-hit" cx="660" cy="420" r="26"></circle>
            <text class="station-label" x="660" y="388" text-anchor="middle">Parallel <tspan class="sub">• Sub 3</tspan></text>
          </g>

          <!-- Misc -->
          <g class="station" data-id="misc" data-title="Miscellaneous" data-parent="misc" data-x="940" data-y="70" tabindex="0">
            <circle class="station-ring" cx="940" cy="70" r="14"></circle>
            <circle class="station-node" cx="940" cy="70" r="10"></circle>
            <circle class="station-hit" cx="940" cy="70" r="26"></circle>
            <text class="station-label" x="940" y="38" text-anchor="middle">Misc</text>
          </g>
          <g class="station" data-id="misc-sub-1" data-title="Misc • Sub 1" data-parent="misc" data-x="940" data-y="300" tabindex="0">
            <circle class="station-ring" cx="940" cy="300" r="14"></circle>
            <circle class="station-node" cx="940" cy="300" r="10"></circle>
            <circle class="station-hit" cx="940" cy="300" r="26"></circle>
            <text class="station-label" x="980" y="304" text-anchor="start">Misc <tspan class="sub">• Sub 1</tspan></text>
          </g>
          <g class="station" data-id="misc-sub-2" data-title="Misc • Sub 2" data-parent="misc" data-x="940" data-y="360" tabindex="0">
            <circle class="station-ring" cx="940" cy="360" r="14"></circle>
            <circle class="station-node" cx="940" cy="360" r="10"></circle>
            <circle class="station-hit" cx="940" cy="360" r="26"></circle>
            <text class="station-label" x="980" y="364" text-anchor="start">Misc <tspan class="sub">• Sub 2</tspan></text>
          </g>
          <g class="station" data-id="misc-sub-3" data-title="Misc • Sub 3" data-parent="misc" data-x="940" data-y="420" tabindex="0">
            <circle class="station-ring" cx="940" cy="420" r="14"></circle>
            <circle class="station-node" cx="940" cy="420" r="10"></circle>
            <circle class="station-hit" cx="940" cy="420" r="26"></circle>
            <text class="station-label" x="980" y="424" text-anchor="start">Misc <tspan class="sub">• Sub 3</tspan></text>
          </g>
        </svg>
  <div class="subway-tooltip" role="status" aria-hidden="true"></div>
</div>


      <!-- Floating Profile Card (top-right of video) -->
      <div class="video-profile-card" aria-label="Profile card">
        <div class="vpc-portrait" aria-hidden="true">
          <div class="vpc-ring"></div>
          <img class="vpc-photo" src="MatthewProfilePic.jpg" alt="Profile picture" />
        </div>

        <div class="vpc-content">
          <div class="vpc-title">
            <div class="vpc-name">Matthew Withers</div>
</div>

          <div class="vpc-role"><span id="vpc-retype">Artist</span></div>

          <div class="vpc-actions">
<button class="vpc-btn" type="button" onclick="vpcCopyEmail('matthew@example.com')" title="Copy email">
              <i class="fas fa-copy"></i> Email
            </button>
            <a class="vpc-btn" href="cv.pdf" download title="Download CV">
              <i class="fas fa-download"></i> CV
            </a>
            <a class="vpc-btn vpc-about" href="#" title="About (external)">
              <i class="fas fa-bolt"></i> About
            </a>
          </div>
        </div>

        <div class="vpc-toast" id="vpc-toast">Copied!</div>
      </div>
    </div>
<!--==========Bars==========-->
</div>
</div>
</div>
</div>
</div>

    
<script>
/* ===== Floating profile card behavior (typing + copy email) ===== */
(function () {
  var elem = document.getElementById("vpc-retype");
  if (!elem) return;

  var phrases = ["Artist", "Developer", "Student", "Human"];
  var idx = 0;

  function typeWord(word, i) {
    if (i <= word.length) {
      elem.textContent = word.slice(0, i);
      setTimeout(function () { typeWord(word, i + 1); }, 110);
    } else {
      setTimeout(function () { deleteWord(word.length); }, 1200);
    }
  }

  function deleteWord(i) {
    if (i >= 0) {
      elem.textContent = elem.textContent.slice(0, i);
      setTimeout(function () { deleteWord(i - 1); }, 60);
    } else {
      idx = (idx + 1) % phrases.length;
      typeWord(phrases[idx], 0);
    }
  }

  // start
  typeWord(phrases[idx], 0);
})();

async function vpcCopyEmail(email) {
  try {
    await navigator.clipboard.writeText(email);
    vpcToast("Copied email!");
  } catch (e) {
    var ta = document.createElement("textarea");
    ta.value = email;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    vpcToast("Copied email!");
  }
}

var vpcToastTimer = null;
function vpcToast(msg) {
  var toast = document.getElementById("vpc-toast");
  if (!toast) return;
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(vpcToastTimer);
  vpcToastTimer = setTimeout(function () {
    toast.classList.remove("show");
  }, 1200);
}
</script>

<script>
      const NIGHT_VIDEOS = new Set([
        "TrainRideNight.webm",
        "TrainRideNight2.webm",
      ]);

      function setBackgroundForVideo(src) {
        // This toggles bg.png <-> bg2.png with a smooth CSS fade
        document.body.classList.toggle("bg-night", NIGHT_VIDEOS.has(src));
      }

      function setVideo(src) {
        const v = document.getElementById("bgvid");
        if (!v) return;

        setBackgroundForVideo(src);

        // Use direct src assignment (reliable). Keep it muted for autoplay.
        v.pause();
        v.src = src;
        v.load();
        v.play().catch(() => {});
      }

      function fishy() {
        setVideo("TrainRide.webm");
      }
      function peng() {
        setVideo("TrainRideNight.webm");
      }
      function foot() {
        setVideo("TrainRideNight2.webm");
      }

      function search() {
        var query = document.getElementById("search").value;
        window.location = "https://www.google.com/#q=" + query;
      }
    </script>
  
    <script>
      /* ===== Starfield Generator (randomized) ===== */
      (function () {
        const MAX_X = 2000;
        const MAX_Y = 2000;

        function buildShadows(n) {
          const parts = new Array(n);
          for (let i = 0; i < n; i++) {
            const x = Math.floor(Math.random() * MAX_X);
            const y = Math.floor(Math.random() * MAX_Y);
            parts[i] = `${x}px ${y}px #FFF`;
          }
          return parts.join(", ");
        }

        const layers = [
          { id: "stars",  count: 700 },
          { id: "stars2", count: 200 },
          { id: "stars3", count: 100 },
        ];

        for (const layer of layers) {
          const el = document.getElementById(layer.id);
          if (!el) continue;
          el.style.setProperty("--shadows", buildShadows(layer.count));
          el.style.setProperty("--shadows2", buildShadows(layer.count));
        }
      })();
    </script>

  
<script>
(function(){
  const root = document.querySelector(".subway-overlay");
  if(!root) return;

  const tooltip = root.querySelector(".subway-tooltip");
  const routes = new Map(Array.from(root.querySelectorAll(".route[data-route]")).map(g => [g.dataset.route, g]));
  const stations = Array.from(root.querySelectorAll(".station[data-id]"));

  const pathByRoute = {
    general:  root.querySelector("#path-general"),
    art:      root.querySelector("#path-art"),
    code:     root.querySelector("#path-code"),
    parallel: root.querySelector("#path-parallel"),
    misc:     root.querySelector("#path-misc"),
  };

  // Links (from original menu)
  const stationLinks = {
    "general": "Resume - Matthew Withers - Jan 20th 2026.pdf",
    "general-sub-1": "https://www.linkedin.com/in/matthew-withers-hr/",
    "general-sub-2": "https://www.youtube.com/@MatthewJamesWithers",
    "art": "rendergallery.html",
    "art-sub-1": "modelgallery.html",
    "art-sub-2": "https://soundcloud.com/organic-analog",
    "code": "https://github.com/MattWithers/MattWithers.github.io",
    "code-sub-1": "https://hak5.org",
    "code-sub-2": "UnfinishedPage.html",
    "misc": "DatingSimHTML5/DatingSimPage.html",
    "misc-sub-1": "HallofProjects/HallofProjects.html"
  };

  // constant “train speed” along the path (slow)
  const pxPerSecond = 260;
  const minDurationMs = 220;
  const maxDurationMs = 2200;
  const opacityMs = 220;

  // retract behavior
  const retractMinMs = 280;
  const retractMaxMs = 1400;

  const startPointByRoute = new Map(); // route -> {x,y}

  function setRouteProgress(routeName, prog01) {
    const g = routes.get(routeName);
    if (!g) return;
    const clamped = Math.max(0, Math.min(1, prog01));
    g.style.setProperty("--prog", clamped);
  }

  function moveTracker(routeName, x, y) {
    const g = routes.get(routeName);
    if (!g) return;
    const t = g.querySelector(".tracker");
    if (!t) return;
    t.setAttribute("transform", `translate(${x} ${y})`);
  }

  function setMotionDuration(routeName, ms) {
    const g = routes.get(routeName);
    if (!g) return;
    const active = g.querySelector(".line-active");
    const tracker = g.querySelector(".tracker");
    const dur = `${ms}ms`;
    if (active) active.style.transitionDuration = `${opacityMs}ms, ${dur}`;
    if (tracker) tracker.style.transitionDuration = `${dur}, ${opacityMs}ms`;
  }

  function closestLengthOnPath(pathEl, targetX, targetY) {
    const total = pathEl.getTotalLength();
    const samples = 260;
    let bestLen = 0;
    let bestDist2 = Infinity;

    for (let i = 0; i <= samples; i++) {
      const l = (i / samples) * total;
      const p = pathEl.getPointAtLength(l);
      const dx = p.x - targetX;
      const dy = p.y - targetY;
      const d2 = dx*dx + dy*dy;
      if (d2 < bestDist2) { bestDist2 = d2; bestLen = l; }
    }

    const window = total / samples;
    let lo = Math.max(0, bestLen - window);
    let hi = Math.min(total, bestLen + window);

    for (let k = 0; k < 18; k++) {
      const m1 = lo + (hi - lo) / 3;
      const m2 = hi - (hi - lo) / 3;
      const p1 = pathEl.getPointAtLength(m1);
      const p2 = pathEl.getPointAtLength(m2);
      const d1 = (p1.x - targetX)**2 + (p1.y - targetY)**2;
      const d2 = (p2.x - targetX)**2 + (p2.y - targetY)**2;
      if (d1 < d2) hi = m2; else lo = m1;
    }
    return (lo + hi) / 2;
  }

  function initRouteLengthsAndStationMetrics() {
    for (const [route, path] of Object.entries(pathByRoute)) {
      if(!path) continue;
      const total = path.getTotalLength();
      const g = routes.get(route);
      if (g) {
        g.style.setProperty("--len", total);
        g.style.setProperty("--prog", 0);
      }
      const start = path.getPointAtLength(0);
      startPointByRoute.set(route, { x: start.x, y: start.y });
    }

    stations.forEach(st => {
      const parent = st.dataset.parent || "general";
      const path = pathByRoute[parent];
      if (!path) return;
      const x = Number(st.dataset.x);
      const y = Number(st.dataset.y);
      const total = path.getTotalLength();
      const lenAt = closestLengthOnPath(path, x, y);
      const prog = total > 0 ? (lenAt / total) : 0;
      st.dataset.lenAt = lenAt.toFixed(3);
      st.dataset.prog = prog.toFixed(6);
    });
  }

  const lastLenAtByRoute = new Map();
  let lastActiveRoute = null;

  function computeDurationMs(route, nextLenAt) {
    const prev = lastLenAtByRoute.get(route);
    const baseLenAt = (lastActiveRoute === route && typeof prev === "number") ? prev : 0;
    const delta = Math.abs(nextLenAt - baseLenAt);
    const pxPerMs = pxPerSecond / 1000;
    let ms = delta / pxPerMs;
    ms = Math.max(minDurationMs, Math.min(maxDurationMs, ms));
    return ms;
  }

  function computeRetractMs(route) {
    const prevLenAt = lastLenAtByRoute.get(route);
    if (typeof prevLenAt !== "number") return retractMinMs;
    const pxPerMs = pxPerSecond / 1000;
    let ms = prevLenAt / pxPerMs;
    ms = Math.max(retractMinMs, Math.min(retractMaxMs, ms));
    return ms;
  }

  function retractRoute(routeName) {
    if (!routeName) return;
    const g = routes.get(routeName);
    if (!g) return;
    if (!g.classList.contains("is-active") && !g.classList.contains("is-leaving")) return;

    const ms = computeRetractMs(routeName);
    setMotionDuration(routeName, ms);

    g.classList.remove("is-active");
    g.classList.add("is-leaving");

    requestAnimationFrame(() => setRouteProgress(routeName, 0));

    window.setTimeout(() => {
      g.classList.remove("is-leaving");
      setRouteProgress(routeName, 0);
    }, ms + 40);
  }

  function animateToStation(parent, targetProg, targetLenAt, targetX, targetY) {
    const g = routes.get(parent);
    if (!g) return;

    if (lastActiveRoute && lastActiveRoute !== parent) {
      retractRoute(lastActiveRoute);
    }

    const ms = computeDurationMs(parent, targetLenAt);
    setMotionDuration(parent, ms);

    if (lastActiveRoute !== parent) {
      const start = startPointByRoute.get(parent) || { x: targetX, y: targetY };
      g.classList.add("no-anim");
      g.classList.add("is-active");
      setRouteProgress(parent, 0);
      moveTracker(parent, start.x, start.y);
      void g.getBoundingClientRect();
      requestAnimationFrame(() => {
        g.classList.remove("no-anim");
        requestAnimationFrame(() => {
          setRouteProgress(parent, targetProg);
          moveTracker(parent, targetX, targetY);
        });
      });
    } else {
      g.classList.add("is-active");
      setRouteProgress(parent, targetProg);
      moveTracker(parent, targetX, targetY);
    }

    lastLenAtByRoute.set(parent, targetLenAt);
    lastActiveRoute = parent;
  }

  function showTooltip(st, clientX, clientY) {
    const t = st.dataset.title || "";
    if (!tooltip || !t) return;
    tooltip.textContent = t;
    const rect = root.getBoundingClientRect();
    tooltip.style.left = `${clientX - rect.left}px`;
    tooltip.style.top  = `${clientY - rect.top}px`;
    tooltip.classList.add("is-visible");
  }
  function hideTooltip(){ tooltip && tooltip.classList.remove("is-visible"); }

  function previewStation(st, evt) {
    const parent = st.dataset.parent || "general";
    const x      = Number(st.dataset.x);
    const y      = Number(st.dataset.y);
    const prog   = Number(st.dataset.prog ?? 0);
    const lenAt  = Number(st.dataset.lenAt ?? 0);
    animateToStation(parent, prog, lenAt, x, y);
    if (evt) showTooltip(st, evt.clientX, evt.clientY);
  }

  function setActiveStation(st) {
    stations.forEach(s => s.classList.remove("is-active"));
    st.classList.add("is-active");
  }

  stations.forEach(st => {
    if (stationLinks[st.dataset.id]) st.dataset.href = stationLinks[st.dataset.id];

    st.addEventListener("mouseenter", (e) => previewStation(st, e));
    st.addEventListener("mousemove",  (e) => showTooltip(st, e.clientX, e.clientY));
    st.addEventListener("mouseleave", hideTooltip);
    st.addEventListener("focus", (e) => previewStation(st, e));
    st.addEventListener("blur", hideTooltip);

    st.addEventListener("click", (e) => {
      e.preventDefault();
      setActiveStation(st);
      if (st.dataset.href) window.location.href = st.dataset.href;
    });

    st.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        setActiveStation(st);
        if (st.dataset.href) window.location.href = st.dataset.href;
      }
    });
  });

  initRouteLengthsAndStationMetrics();
  const defaultStation = stations.find(s => s.dataset.href) || stations[0];
  if (defaultStation) setActiveStation(defaultStation);
})();
</script>

</body>
</html>
